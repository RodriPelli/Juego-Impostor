
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Juego del Impostor ‚Äî Ultra</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;800&display=swap" rel="stylesheet">

<style>
  /* -------------------------
     RESET + BASE
     ------------------------- */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
    background:linear-gradient(180deg,#f6fbff,#eaf5ff);
    color:#0b2545;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }

  /* -------------------------
     APP LAYOUT
     ------------------------- */
  .app {
    width:100%;
    max-width:1020px;
    border-radius:18px;
    overflow:hidden;
    box-shadow: 0 18px 60px rgba(12,36,80,0.14);
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:18px;
    background: linear-gradient(180deg, #ffffff, #f4fbff);
  }

  @media(max-width:980px){
    .app{ grid-template-columns: 1fr; max-width:760px; }
  }

  /* -------------------------
     SPLASH / HEADER
     ------------------------- */
  .splash {
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:22px;
    background: linear-gradient(90deg,#fff,#f0f9ff);
    border-bottom: 1px solid rgba(10,30,60,0.04);
  }

  .logo {
    display:flex;
    gap:12px;
    align-items:center;
  }

  .logo svg { width:56px; height:56px; transform:rotate(-8deg); }
  .title {
    font-weight:800;
    font-size:20px;
    line-height:1;
    color:#032b51;
  }
  .subtitle { font-size:12px; opacity:0.8; color:#174062 }

  /* -------------------------
     LEFT PANEL (game flow)
     ------------------------- */
  .left { padding:20px; display:flex; flex-direction:column; gap:14px; }

  .card {
    background: linear-gradient(180deg,#ffffff,#f7fbff);
    border-radius:12px;
    padding:14px;
    box-shadow: 0 8px 28px rgba(8,30,60,0.05);
    border: 1px solid rgba(10,40,80,0.03);
  }

  label{ display:block; font-size:13px; margin-bottom:8px; color:#09304a; font-weight:600;}

  select,input,textarea {
    width:100%;
    padding:12px 14px;
    border-radius:10px;
    border:1px solid rgba(15,50,90,0.06);
    background: #fff;
    font-size:14px;
    color:#05273f;
  }
  textarea { resize:vertical; min-height:90px; }

  .row { display:flex; gap:10px; align-items:center; }
  .row .col { flex:1 }

  .btn {
    display:inline-block;
    padding:12px 14px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    font-weight:700;
    color:#05273f;
    background: linear-gradient(90deg,#a1d8ff,#86f0ff);
    box-shadow: 0 8px 18px rgba(30,140,200,0.08);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .btn:hover{ transform: translateY(-2px); }

  .btn.secondary {
    background: transparent;
    border: 1px solid rgba(5,39,63,0.08);
    color:#05273f;
    font-weight:700;
  }

  .muted { color:#527a93; font-size:13px }

  /* players list */
  .players-list { display:flex; flex-direction:column; gap:8px; margin-top:8px }
  .player-item {
    padding:10px 12px;
    border-radius:10px;
    display:flex; justify-content:space-between; align-items:center;
    background:linear-gradient(180deg,#f8fdff,#eef9ff);
    border:1px solid rgba(13,70,110,0.03);
  }
  .player-item button { padding:8px 10px; border-radius:8px; font-weight:700; }

  /* reveal grid */
  .reveal-grid { display:grid; grid-template-columns: repeat(2,1fr); gap:10px; }
  @media(max-width:480px){ .reveal-grid{ grid-template-columns: 1fr } }

  .reveal-card{
    padding:12px; border-radius:10px; background:linear-gradient(180deg,#ffffff,#eef8ff);
    border:1px solid rgba(6,40,80,0.04); text-align:center; cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .reveal-card:hover{ transform: translateY(-4px); box-shadow: 0 12px 30px rgba(2,34,60,0.08) }

  /* word modal */
  .modal {
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.98); z-index:9999;
    min-width:260px; max-width:92%; padding:18px; border-radius:14px; text-align:center;
    background: linear-gradient(180deg,#fff,#f2fbff); box-shadow: 0 40px 120px rgba(4,18,40,0.38);
    border: 1px solid rgba(10,40,80,0.06);
    opacity:0; pointer-events:none;
    transition: opacity .18s ease, transform .18s cubic-bezier(.2,.9,.3,1);
  }
  .modal.show{ opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1); }
  .role { font-weight:900; font-size:20px; padding:14px; border-radius:10px; display:inline-block; margin:8px 0; }
  .role.impostor { background: linear-gradient(90deg,#ff6b6b,#ff9a9a); color:white; }
  .role.word { background: linear-gradient(90deg,#ffe08a,#ffb25c); color:#082028; }

  /* footer small */
  .footer { padding:10px; text-align:center; font-size:13px; color:#315b79; opacity:0.9; }

  /* theme dark auto (prefers-color-scheme) */
  @media (prefers-color-scheme: dark) {
    body { background: linear-gradient(180deg,#071028,#001220); color:#e7f6ff; }
    .app { background: linear-gradient(180deg,#051226,#042033); box-shadow: 0 30px 80px rgba(0,0,0,0.6); }
    .splash { background: linear-gradient(90deg,#07112a,#00101a); border-bottom:1px solid rgba(255,255,255,0.03); }
    .card, .player-item, .reveal-card { background: linear-gradient(180deg,#061425,#041522); border:1px solid rgba(255,255,255,0.03); color:#dbeeff }
    .btn { color:#001826; background: linear-gradient(90deg,#2a9bd8,#73e6ff); }
    .btn.secondary { color:#dbeeff; border:1px solid rgba(255,255,255,0.03); }
    .logo text, .title { fill:#cfeeff; color:#cfeeff }
  }

  /* small screens adjustments */
  @media(max-width:520px){
    .app{ padding:12px; gap:12px }
    .splash{ flex-direction:column; align-items:flex-start; gap:8px; padding:14px }
    .logo svg{ width:48px; height:48px }
    .title{ font-size:18px }
    .left{ padding:12px }
    .card{ padding:12px }
  }
</style>
</head>

<body>
  <div class="app" role="application" aria-label="Juego del impostor">
    <!-- SPLASH / HEADER -->
    <div class="splash">
      <div class="logo" aria-hidden="true">
        <!-- simple playful SVG logo -->
        <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="logo">
          <defs>
            <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0" stop-color="#7bd3ff"/>
              <stop offset="1" stop-color="#9df7c4"/>
            </linearGradient>
          </defs>
          <rect x="6" y="6" width="108" height="108" rx="20" fill="url(#g1)" />
          <text x="18" y="74" font-family="Poppins" font-weight="800" font-size="46" fill="#05273f">IM</text>
        </svg>
        <div>
          <div class="title">Juego del Impostor</div>
          <div class="subtitle">R√°pido ‚Ä¢ Offline ‚Ä¢ Multiplayers en un mismo celular</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <div class="muted">Tema</div>
        <select id="themeSelect" aria-label="Seleccionar tema">
          <option value="auto">Autom√°tico</option>
          <option value="light">Claro</option>
          <option value="dark">Oscuro</option>
        </select>
      </div>
    </div>

    <!-- LEFT: flow -->
    <div class="left">
      <!-- SELECT / RANDOM -->
      <div class="card" style="display:flex;flex-direction:column;gap:12px">
        <label for="categorySelect">Eleg√≠ categor√≠a</label>
        <select id="categorySelect" aria-label="Seleccionar categor√≠a"></select>

        <div class="row">
          <button id="btnUseCategory" class="btn">Usar categor√≠a</button>
          <button id="btnRandom" class="btn secondary">Aleatorio üé≤</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <label style="margin:0;min-width:120px">Temporizador (seg)</label>
          <input id="timerInput" type="number" min="0" value="8" style="width:100px" />
          <div style="flex:1;text-align:right" class="muted">0 = sin timer</div>
        </div>
      </div>

      <!-- players input -->
      <div class="card">
        <label for="playersTextarea">Jugadores (un nombre por l√≠nea)</label>
        <textarea id="playersTextarea" placeholder="Ej: Mar√≠a&#10;Juan&#10;Paula" aria-label="Jugadores"></textarea>

        <div style="display:flex;gap:8px;align-items:center">
          <label style="margin:0;min-width:140px">Cant. impostores</label>
          <select id="impostorsCount" style="width:120px">
            <option value="1">1 impostor</option>
            <option value="2">2 impostores</option>
          </select>
          <div style="flex:1"></div>
        </div>

        <div style="display:flex;gap:8px">
          <button id="btnAssignRoles" class="btn">Asignar roles</button>
          <button id="btnReset" class="btn secondary">Reiniciar</button>
        </div>
      </div>

      <!-- players list & controls -->
      <div class="card">
        <label>Jugadores (revelar)</label>
        <div id="playersContainer" class="players-list" style="min-height:60px">No asignados</div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnNewRound" class="btn secondary">Volver a jugar</button>
          <button id="btnEndGame" class="btn secondary">Finalizar</button>
        </div>
      </div>

      <div class="card" style="display:flex;flex-direction:column;gap:8px">
        <label>Instrucciones r√°pidas</label>
        <ol style="margin:6px 0 0 18px; color:#234f67">
          <li>Eleg√≠ categor√≠a o presion√° Aleatorio.</li>
          <li>Escrib√≠ jugadores, uno por l√≠nea.</li>
          <li>Elige 1 o 2 impostores y presion√° Asignar roles.</li>
          <li>Toc√° el nombre para ver la palabra (ocultar al volver).</li>
        </ol>
      </div>
    </div>

    <!-- RIGHT: categories + preview -->
    <aside style="padding:20px; display:flex;flex-direction:column;gap:16px">
      <div class="card" style="flex:1; display:flex; flex-direction:column; gap:12px">
        <label for="searchCat">Buscar categor√≠as</label>
        <input id="searchCat" placeholder="Buscar..." />

        <div style="margin-top:6px; overflow:auto; max-height:420px; padding-right:6px">
          <div id="categoriesList" style="display:grid; grid-template-columns:repeat(1,1fr); gap:8px"></div>
        </div>
      </div>

      <div class="card" id="previewCard" style="display:none">
        <label>Preview ‚Äî palabras</label>
        <div id="previewWords" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px"></div>
      </div>
    </aside>

    <!-- modal (word) -->
    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
        <div id="modalName" style="font-weight:800;font-size:18px;color:#062a44"></div>
        <div id="modalRole" class="role">PALABRA</div>
        <div style="display:flex;gap:10px;width:100%;justify-content:center">
          <button id="btnModalHide" class="btn secondary">Ocultar</button>
          <button id="btnModalNext" class="btn">Siguiente</button>
        </div>
      </div>
    </div>

  </div>

  <div style="height:10px"></div>
  <div class="footer">Hecho con üíô ‚Äî guard√° el archivo y subilo a tu hosting</div>

<script>
/* ============================
   CATEGOR√çAS (20 x 20 palabras)
   Mantener orientaci√≥n argentina
   ============================ */
const CATEGORIES = {
  "Comidas Argentinas": [
    "Asado","Empanada","Milanesa","Fugazzeta","Pizza al molde","Locro","Humita","Tortilla",
    "Chorip√°n","Bondiola","√ëoquis","Canelones","Matambre","Provoleta","Ensalada rusa",
    "Guiso","Ravioles","Sorrentinos","Tarta de jam√≥n","Pastel de papas"
  ],
  "Postres & Facturas": [
    "Dulce de leche","Alfajor","Pastafrola","Chocotorta","Flan","Helado","Medialuna",
    "Pionono","Brownie","Torta Rogel","Masas finas","Crema pastelera","Bud√≠n","Panqueque",
    "Lemon pie","Mousse","Galletitas","Profiteroles","Semifreddo","Tarta de ricota"
  ],
  "Bebidas & Mate": [
    "Mate","Yerba","Fernet","Coca Cola","Gancia","Vino tinto","Vino blanco","Cerveza",
    "Agua","Jugo","Caf√©","Capuchino","T√©","Submarino","Leche","Batido","Sidra","Clericot","Malteada","Jugo de naranja"
  ],
  "Lugares Argentinos": [
    "Bariloche","Mar del Plata","Mendoza","C√≥rdoba","Salta","Jujuy","Iguaz√∫","Ushuaia",
    "El Calafate","La Plata","Rosario","Tandil","San Juan","San Luis","Corrientes",
    "Posadas","Neuqu√©n","Puerto Madryn","Trelew","Paran√°"
  ],
  "Provincias & Ciudades": [
    "Buenos Aires","CABA","Santa Fe","Mendoza","Tucum√°n","Salta","Jujuy","Misiones","Chaco","Formosa",
    "Corrientes","Entre R√≠os","San Luis","San Juan","La Rioja","Catamarca","Neuqu√©n","R√≠o Negro","Chubut","Santa Cruz"
  ],
  "Equipos de F√∫tbol": [
    "Boca Juniors","River Plate","Racing Club","Independiente","San Lorenzo","Estudiantes",
    "Gimnasia","Newell's","Rosario Central","Talleres","Belgrano","Lan√∫s","Argentinos Juniors",
    "V√©lez","Hurac√°n","Col√≥n","Uni√≥n","Defensa y Justicia","Banfield","Tigre"
  ],
  "M√∫sica Argentina": [
    "Soda Stereo","Charly Garc√≠a","Fito P√°ez","Spinetta","Las Pelotas","Patricio Rey","Andr√©s Calamaro",
    "Los Fabulosos Cadillacs","Babasonicos","Duki","Wos","Bizarrap","Tini","Lali","Sandro",
    "Mercedes Sosa","Atahualpa","Los Aut√©nticos Decadentes","La Renga","Ciro"
  ],
  "Programas & Series": [
    "Casados con Hijos","ShowMatch","Gran Hermano","Los Simuladores","Casi √Ångeles","Okupas","El Marginal",
    "Pol√©mica en el Bar","Intrusos","MasterChef","Bake Off","Pasapalabra","Graduados","Avenida Brasil",
    "Telefe Noticias","TN","La Pe√±a del Morfi","Mi amor, mi amor","Sandro (serie)","El Host"
  ],
  "Cosas del Hogar": [
    "Heladera","Cocina","Microondas","Televisor","Silla","Mesa","Cama","Almohada","S√°banas","Toalla",
    "Ducha","Lavarropa","Plancha","Tostadora","Lampara","Espejo","Cortinas","Ventana","Puerta","Bacha"
  ],
  "Objetos Personales": [
    "Celular","Cargador","Auriculares","Control remoto","Llave","Mochila","Bolso","Reloj",
    "Anteojos","Billetera","Cartera","Diadema","Parlante","Camara","Zapatos","Zapatillas",
    "Pulsera","Sombrero","Bufanda","Cintur√≥n"
  ],
  "Animales": [
    "Perro","Gato","Caballo","Vaca","Oveja","Gallina","Conejo","Tortuga","Loro","Delf√≠n",
    "Tibur√≥n","Mono","Le√≥n","Tigre","Zorro","Lobo","Hur√≥n","Puma","Ping√ºino","Cebra"
  ],
  "Profesiones": [
    "Doctor","Enfermero","Maestro","Profesor","Abogado","Ingeniero","Arquitecto","Plomero",
    "Electricista","Carpintero","Cocinero","Panadero","Periodista","Actor","Cantante","Bailar√≠n",
    "Dise√±ador","Fot√≥grafo","Dentista","Farmac√©utico"
  ],
  "Transporte": [
    "Colectivo","Subte","Tren","Auto","Remis","Taxi","Bicicleta","Moto","Avi√≥n",
    "Barco","Ferry","Cami√≥n","Patineta","Monopat√≠n","Metrobus","Cabify","Uber","Helic√≥ptero","Tranv√≠a","Furg√≥n"
  ],
  "Ropa & Accesorios": [
    "Remera","Camisa","Pantal√≥n","Short","Pollera","Vestido","Zapatos","Zapatillas",
    "Medias","Buzo","Campera","Gorro","Bufanda","Cintur√≥n","Corbata","Ojotas","Pijama","Traje","Saco","Chaleco"
  ],
  "Frutas & Verduras": [
    "Manzana","Banana","Naranja","Mandarina","Pomelo","Pera","Durazno","Ciruela","Cereza","Uva",
    "Mel√≥n","Sand√≠a","Kiwi","Anan√°","Tomate","Lechuga","Zanahoria","Papa","Cebolla","Ajo"
  ],
  "Herramientas": [
    "Martillo","Destornillador","Taladro","Sierra","Alicate","Llave inglesa","Regla","Cinta m√©trica",
    "Nivel","Cizalla","Lima","Form√≥n","Cepillo","Pernos","Tornillos","Clavos","Broca","Sierra de mano","Engrampadora","Soplete"
  ],
  "Juegos & Pasatiempos": [
    "Ajedrez","Domin√≥","Truco","Cartas","Metegol","PlayStation","Xbox","Nintendo","Monopoly","Scrabble",
    "Pictionary","Jenga","Bingo","Puzzle","Naipes","Penal","Ruleta","Solitario","Saltar la soga","Damas"
  ],
  "Tecnolog√≠a & Apps": [
    "WhatsApp","Instagram","Facebook","TikTok","YouTube","Mercado Libre","Google Maps","Waze",
    "Spotify","Netflix","Zoom","Meet","Telegram","Homebanking","Mercadopago","Netflix Party","GitHub","Trello","Slack","Notion"
  ],
  "Pel√≠culas & Cine": [
    "Relatos salvajes","El secreto de sus ojos","Nueve reinas","La odisea de los giles","El clan",
    "El hijo de la novia","El secreto","Cuna de lobos","Okupas","El marginal","El secreto de Mar","Volver",
    "El hijo de la novia","La historia oficial","El aura","El abrazo partido","El m√©dico","El corredor","Relatos 2","La odisea"
  ]
};

/* ============================
   STATE
   ============================ */
let state = {
  category: null,
  word: null,
  players: [],   // array of {name, role, seen}
  impostorCount: 1,
  timerSeconds: 8,
  revealIndex: 0,
  roundActive: false
};

/* ============================
   DOM refs
   ============================ */
const categorySelect = document.getElementById('categorySelect');
const btnUseCategory = document.getElementById('btnUseCategory');
const btnRandom = document.getElementById('btnRandom');
const timerInput = document.getElementById('timerInput');

const playersTextarea = document.getElementById('playersTextarea');
const impostorsCount = document.getElementById('impostorsCount');
const btnAssignRoles = document.getElementById('btnAssignRoles');
const btnReset = document.getElementById('btnReset');

const playersContainer = document.getElementById('playersContainer');
const btnNewRound = document.getElementById('btnNewRound');
const btnEndGame = document.getElementById('btnEndGame');

const categoriesList = document.getElementById('categoriesList');
const searchCat = document.getElementById('searchCat');
const previewCard = document.getElementById('previewCard');
const previewWords = document.getElementById('previewWords');

const modal = document.getElementById('modal');
const modalName = document.getElementById('modalName');
const modalRole = document.getElementById('modalRole');
const btnModalHide = document.getElementById('btnModalHide');
const btnModalNext = document.getElementById('btnModalNext');

const themeSelect = document.getElementById('themeSelect');

/* ============================
   INIT
   ============================ */
function init(){
  // populate category select & list
  Object.keys(CATEGORIES).forEach(cat=>{
    const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat;
    categorySelect.appendChild(opt);
  });
  renderCategoriesList();
  // set defaults
  if(categorySelect.options.length>0) {
    state.category = categorySelect.value;
    updatePreview();
  }
  // theme
  applyTheme('auto');
}
init();

/* ============================
   UI helpers
   ============================ */
function renderCategoriesList(filter=''){
  categoriesList.innerHTML = '';
  const keys = Object.keys(CATEGORIES).filter(k=>k.toLowerCase().includes(filter.toLowerCase()));
  keys.forEach(k=>{
    const el = document.createElement('div');
    el.className = 'reveal-card';
    el.innerHTML = `<div style="text-align:left"><strong>${k}</strong><div class="muted" style="font-size:12px;margin-top:6px">${CATEGORIES[k].length} palabras</div></div>`;
    el.onclick = ()=> {
      categorySelect.value = k;
      state.category = k;
      updatePreview();
      window.scrollTo({top:0, behavior:'smooth'});
    };
    categoriesList.appendChild(el);
  });
}

function updatePreview(){
  const cat = categorySelect.value;
  state.category = cat;
  if(!cat) { previewCard.style.display='none'; return; }
  previewCard.style.display='block';
  previewWords.innerHTML = '';
  CATEGORIES[cat].forEach(w=>{
    const s = document.createElement('span'); s.textContent = w;
    s.style.padding='6px 10px'; s.style.borderRadius='10px'; s.style.background='linear-gradient(90deg,#ecf9ff,#f7fbff)';
    s.style.fontSize='13px'; s.style.border='1px solid rgba(10,70,110,0.04)';
    previewWords.appendChild(s);
  });
}

/* search categories */
searchCat.addEventListener('input', e=> renderCategoriesList(e.target.value));
categorySelect.addEventListener('change', updatePreview);

/* theme select */
themeSelect.addEventListener('change', (e)=> applyTheme(e.target.value));
function applyTheme(mode){
  if(mode === 'light'){ document.documentElement.style.background=''; document.body.style.background='linear-gradient(180deg,#f6fbff,#eaf5ff)'; }
  else if(mode === 'dark'){ document.body.style.background='linear-gradient(180deg,#071028,#001220)'; }
  else { // auto
    // respect prefers-color-scheme
    if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.style.background='linear-gradient(180deg,#071028,#001220)';
    } else {
      document.body.style.background='linear-gradient(180deg,#f6fbff,#eaf5ff)';
    }
  }
}


// timer
  const t = parseInt(timerInput.value);
  state.timerSeconds = (isNaN(t) || t < 0) ? 0 : t;

  // choose word if not set (user may have used category)
  if(!state.word) state.word = randomFrom(CATEGORIES[state.category]);

  // pick impostors
  const indices = [...Array(lines.length).keys()];
  shuffle(indices);
  const impostorIdx = indices.slice(0, count);

  state.players = lines.map((name, idx)=>({
    name,
    role: impostorIdx.includes(idx) ? 'IMPOSTOR' : state.word,
    seen: false
  }));

  state.impostorCount = count;
  state.revealIndex = 0;
  state.roundActive = true;

  renderPlayersForReveal();
  scrollToTopSmooth();
});

/* render players for reveal */
function renderPlayersForReveal(){
  playersContainer.innerHTML = '';
  if(!state.players.length){ playersContainer.textContent = 'No hay jugadores'; return; }
  const grid = document.createElement('div');
  grid.className = 'reveal-grid';
  state.players.forEach((p, idx)=>{
    const card = document.createElement('div');
    card.className = 'reveal-card';
    card.innerHTML = `<div style="font-weight:700">${escapeHtml(p.name)}</div><div style="font-size:12px;color:#5b7b8f;margin-top:6px">${p.seen ? 'VISTO' : 'SIN VER'}</div>`;
    card.onclick = ()=> openModalFor(idx);
    grid.appendChild(card);
  });
  playersContainer.appendChild(grid);
}


/* open modal */
let modalTimer = null;
function openModalFor(idx){
  if(!state.roundActive) return;
  const p = state.players[idx];
  modalName.textContent = p.name;
  if(p.role === 'IMPOSTOR'){ modalRole.textContent = 'SOS EL IMPOSTOR'; modalRole.className='role impostor'; }
  else { modalRole.textContent = p.role; modalRole.className='role word'; }
  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');

  // mark seen
  state.players[idx].seen = true;
  renderPlayersForReveal();

  // timer auto-hide
  clearTimeout(modalTimer);
  if(state.timerSeconds > 0){
    modalTimer = setTimeout(()=> {
      closeModal();
      // if auto next: move to next unseen
      autoNextReveal();
    }, state.timerSeconds * 1000);
  }
}

/* close modal */
function closeModal(){
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden','true');
  clearTimeout(modalTimer);
}

/* next button: go to next unseen or finish */
btnModalNext.addEventListener('click', ()=>{
  closeModal();
  autoNextReveal();
});

/* hide button */
btnModalHide.addEventListener('click', ()=> closeModal());

/* auto next: find first unseen and open */
function autoNextReveal(){
  const next = state.players.findIndex(p=>!p.seen);
  if(next === -1){
    // all seen => round finished
    alert('Ronda finalizada. Pueden votar o iniciar nueva ronda.');
    state.roundActive = false;
    return;
  }
  // open next after small delay
  setTimeout(()=> openModalFor(next), 250);
}

/* new round */
btnNewRound.addEventListener('click', ()=>{
  if(!confirm('Iniciar nueva ronda? Se borrar√°n jugadores actuales.')) return;
  resetRound();
});

/* end game */
btnEndGame.addEventListener('click', ()=>{
  if(!confirm('Finalizar partida y limpiar todo?')) return;
  resetAll();
});

/* reset round without clearing category */
function resetRound(){
  state.players = [];
  state.word = null;
  state.revealIndex = 0;
  state.roundActive = false;
  playersTextarea.value = '';
  playersContainer.innerHTML = 'No asignados';
  closeModal();
}

/* reset all */
function resetAll(){
  state = { category: null, word: null, players: [], impostorCount: 1, timerSeconds: 8, revealIndex: 0, roundActive:false };
  playersTextarea.value = '';
  playersContainer.innerHTML = 'No asignados';
  categorySelect.selectedIndex = 0;
  updatePreview();
  closeModal();
}

/* modal keyboard escape */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') closeModal();
});

/* theme auto detect on load */
if(window.matchMedia){
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
    if(themeSelect.value === 'auto') applyAutoTheme();
  });
}

/* helper functions */
function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function shuffle(arr){ let a = arr; for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

function scrollToTopSmooth(){ window.scrollTo({top:0, behavior:'smooth'}); }

/* simple theme handler (auto/light/dark) */
function applyAutoTheme(){ if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){ document.body.style.background='linear-gradient(180deg,#071028,#001220)'; } else { document.body.style.background='linear-gradient(180deg,#f6fbff,#eaf5ff)'; } }
themeSelect.addEventListener('change', ()=>{
  const v = themeSelect.value;
  if(v === 'auto'){ applyAutoTheme(); }
  else if(v === 'light'){ document.body.style.background='linear-gradient(180deg,#f6fbff,#eaf5ff)'; }
  else if(v === 'dark'){ document.body.style.background='linear-gradient(180deg,#071028,#001220)'; }
});

/* render categories list initially */
renderCategoriesList();
updatePreview();

/* attach small event handlers for accessibility */
categorySelect.addEventListener('change', ()=> { state.category = categorySelect.value; updatePreview(); });

/* utility to render categories list (repurpose above) */
function renderCategoriesList(){
  categoriesList.innerHTML = '';
  const keys = Object.keys(CATEGORIES);
  keys.forEach(k=>{
    const node = document.createElement('div');
    node.className = 'reveal-card';
    node.innerHTML = `<strong>${k}</strong><div style="font-size:12px;margin-top:6px;color:#5b7b8f">${CATEGORIES[k].length} palabras</div>`;
    node.onclick = ()=> {
      categorySelect.value = k;
      state.category = k;
      updatePreview();
      window.scrollTo({top:0,behavior:'smooth'});
    };
    categoriesList.appendChild(node);
  });
}



/* updatePreview used earlier but ensure available */
function updatePreview(){
  const cat = categorySelect.value || Object.keys(CATEGORIES)[0];
  state.category = cat;
  previewCard.style.display = cat ? 'block' : 'none';
  previewWords.innerHTML = '';
  (CATEGORIES[cat]||[]).slice(0,20).forEach(w=>{
    const el = document.createElement('span');
    el.textContent = w;
    el.style.padding = '6px 10px';
    el.style.borderRadius = '8px';
    el.style.background = 'linear-gradient(90deg,#ecf9ff,#f8fbff)';
    el.style.fontSize = '13px';
    el.style.margin = '4px';
    el.style.border = '1px solid rgba(10,70,110,0.04)';
    previewWords.appendChild(el);
  });
}

/* expose small features for keyboard use */
document.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase() === 'r' && e.ctrlKey){ // ctrl+r -> random
    e.preventDefault();
    btnRandom.click();
  }
});
</script>
</body>
</html>
